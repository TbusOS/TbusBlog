<!doctype html>
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<link rel="canonical" type="text/html" href="/blog/">
<link rel="alternate" type="application/rss&#43;xml" href="/blog/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Docsy Blog | Tbus</title>
<meta name="description" content="This is the blog section. It has two categories: News and Releases.
Files in these directories will be listed in reverse chronological order.
">
<meta property="og:title" content="Docsy Blog" />
<meta property="og:description" content="TBus team" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/blog/" /><meta property="og:site_name" content="Tbus" />

<meta itemprop="name" content="Docsy Blog">
<meta itemprop="description" content="TBus team"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Docsy Blog"/>
<meta name="twitter:description" content="TBus team"/>




<link rel="preload" href="/scss/main.min.cd6c2bbb05cdf98237b53882fed8c7a8b3fd7a7f7963d7cb305dd0d984782137.css" as="style">
<link href="/scss/main.min.cd6c2bbb05cdf98237b53882fed8c7a8b3fd7a7f7963d7cb305dd0d984782137.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section td-blog">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="font-weight-bold">Tbus</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>关于</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/docs/" ><span>文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/blog/" ><span class="active">博客</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/community/" ><span>团队</span></a>
			</li>
			
			
			<li class="nav-item dropdown mr-4 d-none d-lg-block">
				<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	版本
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/">Latest</a>
	
</div>

			</li>
			
			
			<li class="nav-item dropdown mr-4 d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	中文
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/en/blog/">English</a>
	
</div>
			</li>
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; "
  aria-label=""
  autocomplete="off"
  
  data-offline-search-index-json-src="/offline-search-index.c29856e8ae6d0f417e6991e339bee610.json"
  data-offline-search-base-href="/"
  data-offline-search-max-results="10"
>
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>

<a href="#" onclick="print();return false;"></a>.
</p><p>
<a href="/blog/"></a>.
</p>
</div>



<h1 class="title">Docsy Blog</h1>





    <ul>
    
  
  
  
  

  
    
    
	

    <li><a href="#pg-130e25717d13a65a7dbdcd136755e818">blog-build-environment</a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-ef517223cdada4a3b8f52c81216d3d70">Hugo构建</a></li>



    
  
    
    
	

    <li><a href="#pg-42fd049e4bf55452f4a3d6cfb5cb3d76">typora PicGo</a></li>



    
  
    
    
	

    <li><a href="#pg-4521dfc746afb575652d52ee7e376083">关于Tbus</a></li>



    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-0ae8cd3f20cb4ac8603f6f411f7c628c">CPU</a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-fb94d41c4d1f2327ab92abc40eb67530">cpu多核锁指令-WFE原理</a></li>



    
  

    </ul>
    
  
    
    
	

    <li><a href="#pg-c3689cf8b3880de197b6f5a349856e0a">Linux Build</a></li>



    
    <ul>
        
  
  
  
  

  
    
    
	

    <li><a href="#pg-44addc5440ca3780b0c714de9674c539">qemu-lunchlinux</a></li>



    
  

    </ul>
    
  

    </ul>


<div class="content">
      <p>This is the <strong>blog</strong> section. It has two categories: News and Releases.</p>
<p>Files in these directories will be listed in reverse chronological order.</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-130e25717d13a65a7dbdcd136755e818">blog-build-environment</h1>
	
	<div class="td-byline mb-4">
		
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-ef517223cdada4a3b8f52c81216d3d70">Hugo构建</h1>
	
	<div class="td-byline mb-4">
		 <b>Liulf</b> |
        
		<time datetime="2022-07-20" class="text-muted">2022.07.20</time>
        
	</div>
	<h2 id="clone-博客仓库">Clone 博客仓库</h2>
<blockquote>
<p>将博客clone到本地
尽量使用ssh地址
并再github上配置好公钥</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>git clone git@github.com:TbusOS/blog.git
</span></span></code></pre></div><h2 id="增加一个md文档">增加一个md文档</h2>
<blockquote>
<p>在目录 content\zh\blog\build-environment 下按照已经有的文档写一篇文档</p>
<p><strong>目前博客类的文章都放在这个目录</strong></p>
<p>如果需要不同分类也可以按照blog这个目录下的文档复制一份进行修改</p>
<p>文章的Header按照已有的文章格式写下以下字段</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">linkTitle</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 链接地址</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">author</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Liulf&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 作者</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">categories</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;docs&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 分类</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">tags</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;blog&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;markdown&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;typora&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># tags 分类</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;Hugo构建&#34;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 标题</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">date</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">2022-07-20</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 创建日期</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">weight</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># (这个是文章的顺序)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">description</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 文章描述</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>写完文章后提交到仓库即可</p>
<h2 id="提交文档">提交文档</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>git add .
</span></span><span style="display:flex;"><span>git pus
</span></span></code></pre></div><ul>
<li>提交到github后会博客会自动构建大概需要50秒稍微等待一下</li>
<li>访问<a href="https://tbusos.github.io/">Tbus (tbusos.github.io)</a>刷新一下查看是否更新成功</li>
<li>如果没有更新请联系Liulf</li>
</ul>
<hr>
<p>至此完成一个完整的博客提交流程</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-42fd049e4bf55452f4a3d6cfb5cb3d76">typora PicGo</h1>
	
	<div class="td-byline mb-4">
		 <b>Liulf</b> |
        
		<time datetime="2022-07-20" class="text-muted">2022.07.20</time>
        
	</div>
	<h2 id="1-typora-设置">1. Typora 设置</h2>
<p>设置完成后点击下载PicGo下载PicGo</p>
<p><img src="https://raw.githubusercontent.com/gitliulf/picture/main/1658280424709.png" alt="1658280424709"></p>
<h2 id="2-picgo设置">2. PicGo设置</h2>
<ul>
<li>安装github-plus插件</li>
</ul>
<p><img src="https://raw.githubusercontent.com/TbusOS/TbusBlogDoc/master/blog/pictures.assets/1658283204030.png" alt="1658283204030"></p>
<ul>
<li>去github创建一个Token用于上传图片使用，这一步一定要记下token最好存在</li>
</ul>
<p><img src="https://raw.githubusercontent.com/TbusOS/TbusBlogDoc/master/blog/pictures.assets/1658283319167.png" alt="1658283319167"></p>
<ul>
<li>创建Token至少选择以下权限</li>
</ul>
<p><img src="https://raw.githubusercontent.com/TbusOS/TbusBlogDoc/master/blog/pictures.assets/1658283463904.png" alt=""></p>
<ul>
<li>然后再回到PicGo进行一下设置一下</li>
<li>设置完以后可以在上传区上传一个图片测试</li>
</ul>
<p><img src="https://raw.githubusercontent.com/TbusOS/TbusBlogDoc/master/blog/pictures.assets/1658283059013.png" alt=""></p>
<h2 id="在typora中添加图片将自动上传到github">在Typora中添加图片将自动上传到github</h2>
<p><img src="https://raw.githubusercontent.com/TbusOS/TbusBlogDoc/master/blog/pictures.assets/1658283928561.png" alt="1658283928561"></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-4521dfc746afb575652d52ee7e376083">关于Tbus</h1>
	
	<div class="td-byline mb-4">
		 <b>Liulf</b> |
        
		<time datetime="2022-07-20" class="text-muted">2022.07.20</time>
        
	</div>
	<p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/gBMHA1sBRwljzLrHicWkpD3YCFBdnIiaduKLqpO7vXP1NXdic0GyFrfvFJ20VovaaZOmhkuH02QKdMdq5hJWvntkw/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p>TBUS是什么车？这是去哪里的车？我要怎么样才可以上这辆车？</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/gBMHA1sBRwljzLrHicWkpD3YCFBdnIiadus8iaDXhZOO9Fic3b5kLb7Biaicw4IykGAo7GkCsucNllqtia6OE6GAX2zSQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片"></p>
<p>我们TBUS团队</p>
<p>我们是一个专注于技术学习与分享的团体，目前团队的正式成员涵盖国内顶尖IT技术人员</p>
<p>在这里我们边学习技术边做一些有趣的项目（小游戏，火车售票系统，聊天系统等），这些项目在Linux这个平台上实现。</p>
<p>这不是外包，也不是什么孵化器项目，完全是我们自己的意愿去做，我们想要成立的是一个团队，不是部门也不是其他，最主要是能够有一个学习的氛围，希望能够吸引更多人来这里面学习。</p>
<p>团队名称“TBUS”的构思源自我们团队成员 寓意如下：</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/gBMHA1sBRwmT4bSymyKaN3VhZ0SlmfbMCn4XNJYk5zZCaZMwdlBHdVY78xhjuEWy6MOdEB5Tqu8dUenXBuYnzg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片">Technology(技术)</p>
<hr>
<p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/gBMHA1sBRwmT4bSymyKaN3VhZ0SlmfbM3g8mKI3Gdqib24rH2IMRekTWBF0keeybchPllBzEWvERgbu2lH5pgCg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片">我们团队的创始人</p>
<hr>
<p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/gBMHA1sBRwmT4bSymyKaN3VhZ0SlmfbMlYrROHqzibvPicHr26AiaQCTcp3icWfibjTPLCdwfmFQ2vrdGMNiboLB4WDQ/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片">Unite（团结）</p>
<hr>
<p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/gBMHA1sBRwmT4bSymyKaN3VhZ0SlmfbM5b1yZWyjEqsglzfueVmficL1m7piaIDN30trAiaQIMfUrOrKVXD0lc7Jg/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片">Share（分享）我们团队是以分享交流知识的形式成长的</p>
<hr>
<p>​    此名字是上述团队关键字英文字母的拼接，又可以理解成为一辆学习技术（Technology）的巴士(Bus),走走停停，欢迎志同道合的人上车,结伴同行，一起学习技术，中途也会有一部分人由于种种原因下车。</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_gif/gBMHA1sBRwljzLrHicWkpD3YCFBdnIiadu5SNx2WbQp5JHgUac0kN4Kh0mDApFx7XhkQ1aMdKrMykIiarNphicTnpQ/640?wx_fmt=gif&amp;wxfrom=5&amp;wx_lazy=1" alt="图片"></p>

</div>





    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-0ae8cd3f20cb4ac8603f6f411f7c628c">CPU</h1>
	
	<div class="td-byline mb-4">
		
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-fb94d41c4d1f2327ab92abc40eb67530">cpu多核锁指令-WFE原理</h1>
	<div class="lead">今天我想分享一个跟多核锁原理相关的东西，由于我搞 arm 居多，所以目前只研究了 arm 架构下的 WFE 指令，分享出来，如果有表述不精准或者错误的地方还请大家指出，非常感谢。研究这个原因也是只是想搞清楚所以然和来龙去脉，以后写代码可以更游刃有余.</div>
	<div class="td-byline mb-4">
		 <b>sky (<a href="mailto:zhangbinghua2012@163.com">zhangbinghua2012@163.com</a>)</b> |
        
		<time datetime="2022-07-19" class="text-muted">2022.07.19</time>
        
	</div>
	<p>本文最先发表于泰晓科技：</p>
<p>[https://tinylab.org/arm-wfe/]:</p>
<p><a href="https://tinylab.org/arm-wfe/#author-footer">Zhang Binghua</a> 创作于 2020/05/19</p>
<p>[TOC]</p>
<h2 id="1-背景简介">1 背景简介</h2>
<p>大家好，我叫张昺华，中间那个字和“饼”字一个读音，本人非常热衷技术，是个技术狂热者。</p>
<p>今天我想分享一个跟多核锁原理相关的东西，由于我搞 arm 居多，所以目前只研究了 arm 架构下的 WFE 指令，分享出来，如果有表述不精准或者错误的地方还请大家指出，非常感谢。研究这个原因也是只是想搞清楚所以然和来龙去脉，以后写代码可以更游刃有余。</p>
<h2 id="2-我与-wfe-的初次见面">2 我与 WFE 的初次见面</h2>
<p>偶然看 <code>spin_lock</code> 的 arm 架构下的 smp 源码的时候，发现了 <code>wfe()</code> 这个接口：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">arch_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">arch_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u32</span> <span style="color:#000">newval</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">arch_spinlock_t</span> <span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">prefetchw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">slock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__asm__</span> <span style="color:#000">__volatile__</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;1: ldrex %0, [%3]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; add %1, %0, %4</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; strex %2, %1, [%3]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; teq %2, #0</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; bne 1b&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">newval</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">slock</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;I&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">TICKET_SHIFT</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cc&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">next</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">owner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wfe</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">owner</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">READ_ONCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">owner</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">smp_mb</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>我印象之前的 kernel 是没有这个 wfe 这个函数的，当 cpu0 获取到锁后，如果 cpu1 再想获取锁，此时会被 lock 住，然后进入死等的状态，那么 wfe 这个指令的作用是会让 cpu 进入 low power standby，这样可以降低功耗，本来发生竞态时其他的 cpu 都要等待这个锁释放才能运行，有了这个指令，相当于是“因祸得福”了，还可以降低功耗，当然这是有条件的，后面追溯并研究了一下 wfe 这个指令的作用。</p>
<h2 id="3-spinlock-与-wfesevwfi">3 spinlock 与 WFE、SEV、WFI</h2>
<p>首先 <code>spin_lock</code> 函数，搞内核的大家都知道，那么我把 linux-stable 的代码黏贴出来如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">__always_inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">rlock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define raw_spin_lock(lock)	_raw_spin_lock(lock)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#ifndef CONFIG_INLINE_SPIN_LOCK
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">__lockfunc</span> <span style="color:#000">_raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">raw_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">EXPORT_SYMBOL</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_raw_spin_lock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">__raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">raw_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">preempt_disable</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">spin_acquire</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dep_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_RET_IP_</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">LOCK_CONTENDED</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">do_raw_spin_trylock</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">do_raw_spin_lock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">* We are now relying on the NMI watchdog to detect lockup instead of doing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">* the detection here with an unfair lock which can cause problem of its own.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">do_raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">raw_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">debug_spin_lock_before</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">arch_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">raw_lock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mmiowb_spin_lock</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">debug_spin_lock_after</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">* ARMv6 ticket-based spin-locking.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">* A memory barrier is required after we get a lock, and before we
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">* release it, because V6 CPUs are assumed to have weakly ordered
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">* memory.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">arch_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">arch_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u32</span> <span style="color:#000">newval</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">arch_spinlock_t</span> <span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">prefetchw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">slock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__asm__</span> <span style="color:#000">__volatile__</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;1: ldrex %0, [%3]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; add %1, %0, %4</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; strex %2, %1, [%3]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; teq %2, #0</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; bne 1b&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">newval</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">slock</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;I&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">TICKET_SHIFT</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cc&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">next</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">owner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wfe</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">owner</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">READ_ONCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">owner</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">smp_mb</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>对于 arm32：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#if __LINUX_ARM_ARCH__ &gt;= 7 || \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	(__LINUX_ARM_ARCH__ == 6 &amp;&amp; defined(CONFIG_CPU_32v6K))
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define sev()	__asm__ __volatile__ (&#34;sev&#34; : : : &#34;memory&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define wfe()	__asm__ __volatile__ (&#34;wfe&#34; : : : &#34;memory&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define wfi()	__asm__ __volatile__ (&#34;wfi&#34; : : : &#34;memory&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#else
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define wfe()	do { } while (0)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span></code></pre></div><p>对于 arm64：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define sev()		asm volatile(&#34;sev&#34; : : : &#34;memory&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define wfe()		asm volatile(&#34;wfe&#34; : : : &#34;memory&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define wfi()		asm volatile(&#34;wfi&#34; : : : &#34;memory&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">arch_spin_unlock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">arch_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">smp_mb</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">owner</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsb_sev</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SEV		__ALT_SMP_ASM(WASM(sev), WASM(nop))
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">dsb_sev</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ishst</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__asm__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SEV</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#ifdef CONFIG_SMP
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __ALT_SMP_ASM(smp, up)						\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	&#34;9998: &#34; smp &#34;\n&#34;						\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	&#34; .pushsection \&#34;.alt.smp.init\&#34;, \&#34;a\&#34;\n&#34;		\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	&#34; .long 9998b\n&#34;					\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	&#34; &#34; up &#34;\n&#34;						\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	&#34; .popsection\n&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#else
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __ALT_SMP_ASM(smp, up)	up
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span></code></pre></div><p>以上我们可以看出，在 lock 的时候使用 WFE，在 unlock 的时候使用 SEV，这个必须要成对使用，原因我下面会说。</p>
<p>对于内核版本 Linux 3.0.56：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">arch_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">arch_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__asm__</span> <span style="color:#000">__volatile__</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;1: ldrex %0, [%1]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; teq %0, #0</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WFE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ne&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; strexeq %0, %2, [%1]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; teqeq %0, #0</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; bne 1b&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cc&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">smp_mb</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>对于 Linux 2.6.18：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">define</span> <span style="color:#000">_raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>     <span style="color:#000">__raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">raw_lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">__raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">raw_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__asm__</span> <span style="color:#000">__volatile__</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;1: ldrex %0, [%1]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; teq %0, #0</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; strexeq %0, %2, [%1]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; teqeq %0, #0</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; bne 1b&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cc&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">smp_mb</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以上大家可以看出，最早期的 kernel 版本是没有 wfe 这条指令的，后面的版本才有。</p>
<h2 id="4-wfesev-与-wfi-的作用与工作原理">4 WFE、SEV 与 WFI 的作用与工作原理</h2>
<p>那这条指令的作用是什么呢？我们可以上 arm 官网去查看这条指令的描述：<a href="http://infocenter.arm.com/help/index.jsp?lang=en">ARM Software development tools</a></p>
<ul>
<li>
<p>SEV</p>
<blockquote>
<p>SEV causes an event to be signaled to all cores within a multiprocessor system. If SEV is implemented, WFE must also be implemented.</p>
</blockquote>
</li>
</ul>
<p>SEV 指令可以产生事件信号，发送给全部的 cpu，让他们唤醒。如果 SEV 实现了，那么 WFE 也必须被实现。这里的事件信号其实会表现为 Event register，这是个一 bit 的 register，如果有事件，那么此 bit 为真。</p>
<ul>
<li>WFE</li>
</ul>
<blockquote>
<p>If the Event Register is not set, WFE suspends execution until one of the following events occurs:</p>
<p>• an IRQ interrupt, unless masked by the CPSR I-bit • an FIQ interrupt, unless masked by the CPSR F-bit • an Imprecise Data abort, unless masked by the CPSR A-bit • a Debug Entry request, if Debug is enabled • an Event signaled by another processor using the SEV instruction.</p>
<p>If the Event Register is set, WFE clears it and returns immediately. If WFE is implemented, SEV must also be implemented.</p>
</blockquote>
<p>对于 WFE，如果 Event Register 没有设置，WFE 会让 cpu 进入 low-power state，直到下面列举的五个 events 产生，比如说中断等等都会唤醒当前因为 WFE 而 suspend 的cpu。</p>
<p>如果 Event Register 被设置了，那么 WFE 会直接返回，不让 cpu 进入low-power state，目的是因为既然有事件产生了，说明当前 cpu 需要干活，不能 suspend，所以才这样设计。</p>
<p>这里我很好奇 Event Register 到底是怎么理解的。因此需要阅读手册《ARM Architecture Reference Manual.pdf》，下面我会做说明。</p>
<ul>
<li>WFI</li>
</ul>
<blockquote>
<p>WFI suspends execution until one of the following events occurs:</p>
<p>• an IRQ interrupt, regardless of the CPSR I-bit • an FIQ interrupt, regardless of the CPSR F-bit • an Imprecise Data abort, unless masked by the CPSR A-bit • a Debug Entry request, regardless of whether Debug is enabled.</p>
</blockquote>
<p>而对于 WFI 这种，不会判断 Event register，暴力的直接让 cpu 进入 low-power state，直到有上述四个 events 产生才会唤醒 cpu。</p>
<p>注意，这里 WFE 比 WFI 多了一个唤醒特性：</p>
<blockquote>
<p>an Event signaled by another processor using the SEV instruction.</p>
</blockquote>
<p>也就是说 SEV 是不会唤醒 WFI 指令休眠的 cpu 的。这点需要特别注意。</p>
<p>接下来我谈下这个 Event Register 是怎么回事了。看这个文档《ARM Architecture Reference Manual.pdf》</p>
<ul>
<li>The Event Register</li>
</ul>
<blockquote>
<p>The Event Register is a single bit register for each processor. When set, an event register indicates that an event has occurred, since the register was last cleared, that might require some action by the processor. Therefore, the processor must not suspend operation on issuing a WFE instruction.</p>
<p>The reset value of the Event Register is UNKNOWN.</p>
<p>The Event Register is set by:</p>
<p>• an SEV instruction • an event sent by some IMPLEMENTATION DEFINED mechanism • a debug event that causes entry into Debug state • an exception return.</p>
<p>As shown in this list, the Event Register might be set by IMPLEMENTATION DEFINED mechanisms. The Event Register is cleared only by a Wait For Event instruction. Software cannot read or write the value of the Event Register directly.</p>
</blockquote>
<p>以上就是 Event Register 的表述，上述已经说的很明白了，Event Register 只有一个 bit，可以被 set 的情况总有四种大类型。当任意一个条件满足的时候，Event Register 都可以被 set，那么当 WFE 进入的时候会进行 Event Register 的判断，如果为真，就直接返回。</p>
<p>再来看看 WFE 的介绍：</p>
<blockquote>
<p>Wait For Event is a hint instruction that permits the processor to enter a low-power state until one of a number of events occurs, including events signaled by executing the SEV instruction on any processor in the multiprocessor system. For more information, see Wait For Event and Send Event on page B1-1197.</p>
<p>In an implementation that includes the Virtualization Extensions, if HCR.TWE is set to 1, execution of a WFE instruction in a Non-secure mode other than Hyp mode generates a Hyp Trap exception if, ignoring the value of the HCR.TWE bit, conditions permit the processor to suspend execution. For more information see Trapping use of the WFI and WFE instructions on page B1-1249.</p>
</blockquote>
<p>接下来上 WFE 这条指令的伪代码流程：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">Assembler</span> <span style="color:#000">syntax</span>
</span></span><span style="display:flex;"><span><span style="color:#000">WFE</span><span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">c</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">}{</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">q</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">where</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">c</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">q</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">See</span> <span style="color:#000">Standard</span> <span style="color:#000">assembler</span> <span style="color:#000">syntax</span> <span style="color:#000">fields</span> <span style="color:#000">on</span> <span style="color:#000">page</span> <span style="color:#000">A8</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">285.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Operation</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ConditionPassed</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">EncodingSpecificOperations</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">EventRegistered</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ClearEventRegister</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">HaveVirtExt</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">IsSecure</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">CurrentModeIsHyp</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">HCR</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TWE</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;1&#39;</span> <span style="color:#000">then</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">HSRString</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Zeros</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">HSRString</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;1&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">WriteHSR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">&#39;</span><span style="color:#0000cf;font-weight:bold">000001</span><span style="color:#a40000">&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HSRString</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">TakeHypTrapException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">WaitForEvent</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Exceptions</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Hyp</span> <span style="color:#000">Trap</span><span style="color:#000;font-weight:bold">.</span>
</span></span></code></pre></div><p>看了上面这段 WFE 的伪代码，一目了然，首先判断 <code>ConditionPassed()</code>，这些函数大家可以在 arm 手册中查看其详细含义，如果 <code>EventResigerted()</code> 函数为真，也就是这个 1 bit 的寄存器为真，那么就清除此 bit，然后退出返回，不会让 cpu 进入 low power state；</p>
<p>如果不是异常处理，<code>TakeHypTrapException()</code>，那么就 <code>WaitForEvent()</code>，等待唤醒事件到来，到来了，就唤醒当前 cpu。</p>
<p>为什么有事件来了就直接返回呢，因为 WFE 的设计认为，如果此时有 event 事件，那么说明当前 cpu 要干活，那就没必要进入 low power state 模式。</p>
<p>如果没有事件产生，那么就可以进入 low power state 模式，因为 cpu 反正也是在等待锁，此时也干不了别的事情，还不如休眠还可以降低功耗。</p>
<p>当然，irq，fiq 等很多中断都可以让 WFE 休眠的 cpu 唤醒，那么这样做还有什么意义呢？比如说时钟中断是一直产生的，那么 cpu 很快就醒了啊，都不用等到发 SEV，那么既然是用 <code>spin_lock</code>，也可以在中断上半部使用，也可以在进程上下文，既然是自旋锁，就意味着保护的这段代码是要足够精简，不希望被其他东西打断，那么如果你保护的这部分代码非常长，这时候整个系统响应很可能会变慢，因为如果这时候有人也要使用这个锁的话，那么是否保护的这段代码设计上是有问题的。因此用 <code>spin_lock</code> 保护的函数尽可能要短，如果长的话可能需要换其他锁，或者考虑下是否真的要这么长的保护措施。</p>
<p><strong><code>TakeHypTrapException()</code>，是进入异常处理</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">Pseudocode</span> <span style="color:#000">description</span> <span style="color:#000">of</span> <span style="color:#000">taking</span> <span style="color:#000">the</span> <span style="color:#000">Hyp</span> <span style="color:#000">Trap</span> <span style="color:#000">exception</span>
</span></span><span style="display:flex;"><span><span style="color:#000">The</span> <span style="color:#000">TakeHypTrapException</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">pseudocode</span> <span style="color:#000">procedure</span> <span style="color:#000">describes</span> <span style="color:#000">how</span> <span style="color:#000">the</span> <span style="color:#000">processor</span> <span style="color:#000">takes</span> <span style="color:#000">the</span> <span style="color:#f57900">exception</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TakeHypTrapException()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ======================
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">TakeHypTrapException</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// HypTrapException is caused by executing an instruction that is trapped to Hyp mode as a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// result of a trap set by a bit in the HCR, HCPTR, HSTR or HDCR. By definition, it can only
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// be generated in a Non-secure mode other than Hyp mode.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Note that, when a Supervisor Call exception is taken to Hyp mode because HCR.TGE==1, this
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// is not a trap of the SVC instruction. See the TakeSVCException() pseudocode for this case.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">preferred_exceptn_return</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">CPSR</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;1&#39;</span> <span style="color:#000">then</span> <span style="color:#000">PC</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000">PC</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">new_spsr_value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">CPSR</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">EnterHypMode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">new_spsr_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preferred_exceptn_return</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Additional</span> <span style="color:#000">pseudocode</span> <span style="color:#000">functions</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">exception</span> <span style="color:#000">handling</span> <span style="color:#000">on</span> <span style="color:#000">page</span> <span style="color:#000">B1</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1221</span> <span style="color:#000">defines</span> <span style="color:#000">the</span> <span style="color:#000">EnterHypMode</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">pseudocode</span>
</span></span><span style="display:flex;"><span><span style="color:#000">procedure</span><span style="color:#000;font-weight:bold">.</span>
</span></span></code></pre></div>






<div class="card rounded p-2 td-post-card mb-4 mt-4" style="max-width: 810px">
	<img class="card-img-top" src="/blog/2022/07/19/cpu%E5%A4%9A%E6%A0%B8%E9%94%81%E6%8C%87%E4%BB%A4-wfe%E5%8E%9F%E7%90%86/image-20220719201300279_hu16ba9ede6f8109a7933eccf29aa0d9ee_82343_800x400_fill_catmullrom_smart1_3.png" width="800" height="400">
	
	<div class="card-body px-0 pt-2 pb-0">
		<p class="card-text">
<small class="text-muted"><br/>arm spec</small></p>
	</div>
	
</div>
<p><strong>ClearEventRegister()</strong></p>
<p>Clear the Event Register of the current processor 清除Event Register的bit</p>
<p><strong>EventRegistered()</strong></p>
<p>Determine whether the Event Register of the current processor is set Event Register bit为真，即被设置过</p>
<p><strong>WaitForEvent()</strong></p>
<p>Wait until WFE instruction completes</p>
<p>等待 Events 事件，有任何一个 Event 事件来临，都会唤醒当前被 WFE suspend 下去的 cpu， 如果是 SEV，会唤醒全部被 WFE suspend 下去的cpu。</p>
<p>如下是关于 WFE 的 wake up events 事件描述和列举：</p>
<blockquote>
<p>WFE wake-up events</p>
<p>The following events are WFE wake-up events:</p>
<p>• the execution of an SEV instruction on any processor in the multiprocessor system • a physical IRQ interrupt, unless masked by the CPSR.I bit • a physical FIQ interrupt, unless masked by the CPSR.F bit • a physical asynchronous abort, unless masked by the CPSR.A bit • in Non-secure state in any mode other than Hyp mode: — when HCR.IMO is set to 1, a virtual IRQ interrupt, unless masked by the CPSR.I bit — when HCR.FMO is set to 1, a virtual FIQ interrupt, unless masked by the CPSR.F bit — when HCR.AMO is set to 1, a virtual asynchronous abort, unless masked by the CPSR.A bit • an asynchronous debug event, if invasive debug is enabled and the debug event is permitted • an event sent by the timer event stream, see Event streams on page B8-1934 • an event sent by some IMPLEMENTATION DEFINED mechanism.</p>
<p>In addition to the possible masking of WFE wake-up events shown in this list, when invasive debug is enabled and DBGDSCR[15:14] is not set to 0b00, DBGDSCR.INTdis can mask interrupts, including masking them acting as WFE wake-up events. For more information, see DBGDSCR, Debug Status and Control Register on page C11-2206. As shown in the list of wake-up events, an implementation can include IMPLEMENTATION DEFINED hardware mechanisms to generate wake-up events. NoteFor more information about CPSR masking see Asynchronous exception masking on page B1-1181. If the configuration of the masking controls provided by the Security Extensions, or Virtualization Extensions, mean that a CPSR mask bit cannot mask the corresponding exception, then the physical exception is a WFE wake-up event, regardless of the value of the CPSR mask bit.</p>
</blockquote>
<p>接下来我们看下 WFI 的伪代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">Assembler</span> <span style="color:#000">syntax</span>
</span></span><span style="display:flex;"><span><span style="color:#000">WFI</span><span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">c</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">}{</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">q</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">where</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">c</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">q</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">See</span> <span style="color:#000">Standard</span> <span style="color:#000">assembler</span> <span style="color:#000">syntax</span> <span style="color:#000">fields</span> <span style="color:#000">on</span> <span style="color:#000">page</span> <span style="color:#000">A8</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">285.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Operation</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ConditionPassed</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">EncodingSpecificOperations</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">HaveVirtExt</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">IsSecure</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">CurrentModeIsHyp</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">HCR</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TWI</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;1&#39;</span> <span style="color:#000">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">HSRString</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Zeros</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">HSRString</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;1&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">WriteHSR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">&#39;</span><span style="color:#0000cf;font-weight:bold">000001</span><span style="color:#a40000">&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HSRString</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">TakeHypTrapException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">WaitForInterrupt</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Exceptions</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Hyp</span> <span style="color:#000">Trap</span><span style="color:#000;font-weight:bold">.</span>
</span></span></code></pre></div><p>相关解释：</p>
<blockquote>
<p>WFI</p>
<p>Wait For Interrupt is a hint instruction that permits the processor to enter a low-power state until one of a number of asynchronous events occurs. For more information, see Wait For Interrupt on page B1-1200. In an implementation that includes the Virtualization Extensions, if HCR.TWI is set to 1, execution of a WFE instruction in a Non-secure mode other than Hyp mode generates a Hyp Trap exception if, ignoring the value of the HCR.TWI bit, conditions permit the processor to suspend execution. For more information see Trapping use of the WFI and WFE instructions on page B1-1249.</p>
</blockquote>
<p>以上我们可以看出，WFI 并没有去判断 event register，因此看伪代码可以很直观的看出 WFI 与 WFE 的区别。</p>
<p>以上是我个人的理解，如果有表述不精准或者不准确的地方还请大家指出，欢迎交流。</p>
<h2 id="5-参考资料">5 参考资料</h2>
<ul>
<li><a href="https://blog.csdn.net/adaptiver/article/details/72389453">ARM 架构下 spinlock 原理 (代码解读)</a></li>
<li><a href="http://www.wowotech.net/armv8a_arch/wfe_wfi.html">ARM WFI 和 WFE 指令</a></li>
<li><a href="http://infocenter.arm.com/help/index.jsp?lang=en">ARM Software development tools</a></li>
<li><a href="https://www.jianshu.com/p/f0d6e7103d9b">Linux 内核自旋锁 <code>spinlock_t</code> 机制</a></li>
</ul>

</div>





    
	
  

    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-c3689cf8b3880de197b6f5a349856e0a">Linux Build</h1>
	
	<div class="td-byline mb-4">
		
        
	</div>
	
</div>





    
      
  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-44addc5440ca3780b0c714de9674c539">qemu-lunchlinux</h1>
	
	<div class="td-byline mb-4">
		 <b>廖文雄</b> |
        
		<time datetime="2022-07-18" class="text-muted">2022.07.18</time>
        
	</div>
	<h1 id="版本信息">版本信息</h1>
<p>系统版本：Ubuntu Server 20.04 LTS 64bit
编译器：9.4.0
交叉编译器：arm-linux-gnueabi-gcc  (Linaro GCC 7.5-2019.12)  7.5.0
linux内核：linux-5.15.53
busybox：1.35.0
QEMU：7.0.0
ninja-build：1.10.0</p>
<h1 id="获取交叉编译链">获取交叉编译链</h1>
<p>下载地址：<a href="https://releases.linaro.org/components/toolchain/binaries/7.5-2019.12/arm-linux-gnueabi/">Linaro Releases</a>
<img src="C:%5CUsers%5Cliulf%5CDesktop%5C%E5%8D%9A%E5%AE%A2%5Cpictures.assets%5Cimage-20220718155906055.png" alt="image-20220718155906055"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>tar xvf gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabi.tar.tar	<span style="color:#8f5902;font-style:italic">#解压</span>
</span></span><span style="display:flex;"><span>vi ~/.bashrc	<span style="color:#8f5902;font-style:italic">#修改环境变量PATH，让系统先去指定目录寻找交叉编译链的可执行文件</span>
</span></span></code></pre></div><p><img src="https://raw.githubusercontent.com/gitliulf/picture/main/image-20220718160818198.png" alt="image-20220718160818198">
在.bashrc文件加上这行，交叉工具链的目录取决于自己解压的目录
export PATH=/home/ubuntu/gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabi/bin:$PATH</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#204a87">source</span> ~/.bashrc	<span style="color:#8f5902;font-style:italic">#让.bashrc生效</span>
</span></span></code></pre></div><p>安装成功
<img src="https://raw.githubusercontent.com/gitliulf/picture/main/image-20220718160830447.png" alt="image-20220718160830447"></p>
<h1 id="编译qemu">编译QEMU</h1>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo apt-get install ninja-build	<span style="color:#8f5902;font-style:italic">#Need ninja. Ninja is a small build system with a focus on speed. </span>
</span></span><span style="display:flex;"><span>wget https://download.qemu.org/qemu-7.0.0.tar.xz	<span style="color:#8f5902;font-style:italic">#下载源码</span>
</span></span><span style="display:flex;"><span>tar xvf qemu-7.0.0.tar.xz	<span style="color:#8f5902;font-style:italic">#解压</span>
</span></span><span style="display:flex;"><span>mkdir qemu_build <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87">cd</span> qemu_build	<span style="color:#8f5902;font-style:italic"># 在下载目录新建文件夹build</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 以下均在/build目录下</span>
</span></span><span style="display:flex;"><span>../qemu-7.0.0/configure
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>make <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> make install	<span style="color:#8f5902;font-style:italic">#出去喝杯咖啡，打两把游戏在来看结果</span>
</span></span></code></pre></div><p>编译成功后，qemu-system-arm就生成在当前目录
和上面一样，将编译出的qemu的可执行文件的目录加入PATH环境变量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vi ~/.bashrc	<span style="color:#8f5902;font-style:italic">#修改环境变量PATH</span>
</span></span></code></pre></div><p>在.bashrc文件上次修改的基础上，重新修改
export PATH=/home/ubuntu/qemu_build:/home/ubuntu/gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabi/bin:$PATH</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#204a87">source</span> ~/.bashrc	<span style="color:#8f5902;font-style:italic">#让.bashrc生效</span>
</span></span></code></pre></div><p>安装成功
<img src="https://raw.githubusercontent.com/gitliulf/picture/main/image-20220718160842204.png" alt="image-20220718160842204"></p>
<h1 id="编译linux内核">编译Linux内核</h1>
<p>内核代码下载地址：<a href="https://www.kernel.org/">The Linux Kernel Archives</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>make <span style="color:#000">ARCH</span><span style="color:#ce5c00;font-weight:bold">=</span>arm <span style="color:#000">CROSS_COMPILE</span><span style="color:#ce5c00;font-weight:bold">=</span>arm-linux-gnueabi- vexpress_defconfig
</span></span><span style="display:flex;"><span>make <span style="color:#000">ARCH</span><span style="color:#ce5c00;font-weight:bold">=</span>arm <span style="color:#000">CROSS_COMPILE</span><span style="color:#ce5c00;font-weight:bold">=</span>arm-linux-gnueabi- menuconfig
</span></span><span style="display:flex;"><span>make <span style="color:#000">ARCH</span><span style="color:#ce5c00;font-weight:bold">=</span>arm <span style="color:#000">CROSS_COMPILE</span><span style="color:#ce5c00;font-weight:bold">=</span>arm-linux-gnueabi- -j2
</span></span></code></pre></div><p>ps：Versatile Express系统由ARM Ltd提供，作为CortexA9四核处理器的开发环境，硬件由uATX主板和CoreTile Express A9x4子板组成。</p>
<h2 id="验证只启动linux内核">验证只启动Linux内核</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>qemu-system-arm -M vexpress-a9 -m 128M -kernel ~/linux-5.15.53/arch/arm/boot/zImage -dtb ~/linux-5.15.53/arch/arm/boot/dts/vexpress-v2p-ca9.dtb -nographic
</span></span></code></pre></div><p>ps：内核和设备树的路径每个人可能不一样，需要自己注意下</p>
<p><img src="https://raw.githubusercontent.com/gitliulf/picture/main/image-20220718160857131.png" alt="image-20220718160857131">
启动成功，但还没有文件系统，操作系统稍后制作。
输入ctrl+A+x退出qemu</p>
<h1 id="编译busybox制作文件系统">编译busybox，制作文件系统</h1>
<h2 id="编译">编译</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>wget https://busybox.net/downloads/busybox-1.35.0.tar.bz2	<span style="color:#8f5902;font-style:italic">#下载源码</span>
</span></span><span style="display:flex;"><span>tar xvf busybox-1.35.0.tar.bz2	<span style="color:#8f5902;font-style:italic">#解压</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> busybox-1.35.0/
</span></span><span style="display:flex;"><span>make <span style="color:#000">ARCH</span><span style="color:#ce5c00;font-weight:bold">=</span>arm <span style="color:#000">CROSS_COMPILE</span><span style="color:#ce5c00;font-weight:bold">=</span>arm-linux-gnueabi- defconfig
</span></span><span style="display:flex;"><span>make <span style="color:#000">ARCH</span><span style="color:#ce5c00;font-weight:bold">=</span>arm <span style="color:#000">CROSS_COMPILE</span><span style="color:#ce5c00;font-weight:bold">=</span>arm-linux-gnueabi- menuconfig
</span></span></code></pre></div><ul>
<li>
<blockquote>
<p>Settings —&gt;</p>
<ul>
<li>[*] Build static binary (no shared libs) #使用静态库</li>
</ul>
</blockquote>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>make <span style="color:#000">ARCH</span><span style="color:#ce5c00;font-weight:bold">=</span>arm <span style="color:#000">CROSS_COMPILE</span><span style="color:#ce5c00;font-weight:bold">=</span>arm-linux-gnueabi- -j4
</span></span><span style="display:flex;"><span>make <span style="color:#000">ARCH</span><span style="color:#ce5c00;font-weight:bold">=</span>arm <span style="color:#000">CROSS_COMPILE</span><span style="color:#ce5c00;font-weight:bold">=</span>arm-linux-gnueabi- install
</span></span></code></pre></div><ul>
<li>生成结果位于：当前根目录下的_install文件夹下</li>
<li>备注：默认安装到根目录下的_install，若想更改，可以通过menuconfig里面的选项更改</li>
</ul>
<h2 id="制作文件系统镜像">制作文件系统镜像</h2>
<h3 id="根目录构建">根目录构建</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mkdir -p rootfs/<span style="color:#ce5c00;font-weight:bold">{</span>dev,etc/init.d,lib,proc,sys<span style="color:#ce5c00;font-weight:bold">}</span>   <span style="color:#8f5902;font-style:italic">#创建根目录</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cp -raf busybox-1.35.0/_install/* rootfs        <span style="color:#8f5902;font-style:italic">#拷贝busybox命令到根目录</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo mknod -m <span style="color:#0000cf;font-weight:bold">666</span> rootfs/dev/tty1 c <span style="color:#0000cf;font-weight:bold">4</span> 1			<span style="color:#8f5902;font-style:italic">#创建4个tty端终设备</span>
</span></span><span style="display:flex;"><span>sudo mknod -m <span style="color:#0000cf;font-weight:bold">666</span> rootfs/dev/tty1 c <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>sudo mknod -m <span style="color:#0000cf;font-weight:bold">666</span> rootfs/dev/tty2 c <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>sudo mknod -m <span style="color:#0000cf;font-weight:bold">666</span> rootfs/dev/tty3 c <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>sudo mknod -m <span style="color:#0000cf;font-weight:bold">666</span> rootfs/dev/tty4 c <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>sudo mknod -m <span style="color:#0000cf;font-weight:bold">666</span> rootfs/dev/console c <span style="color:#0000cf;font-weight:bold">5</span> 1		<span style="color:#8f5902;font-style:italic">#创建console字符设备</span>
</span></span><span style="display:flex;"><span>sudo mknod -m <span style="color:#0000cf;font-weight:bold">666</span> rootfs/dev/null c <span style="color:#0000cf;font-weight:bold">1</span> 3			<span style="color:#8f5902;font-style:italic">#创建null 字符设备</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>vim rootfs/etc/init.d/rcS						<span style="color:#8f5902;font-style:italic">#输入如下内容</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>mount -t proc proc /proc 
</span></span><span style="display:flex;"><span>mount -t sysfs sysfs /sys 
</span></span><span style="display:flex;"><span>/sbin/mdev -s 
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> /sbin/mdev &gt; /proc/sys/kernel/hotplug      <span style="color:#8f5902;font-style:italic">#支持热插拔</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo chmod +x rootfs/etc/init.d/rcS
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> rootfs
</span></span><span style="display:flex;"><span>find ./ <span style="color:#000;font-weight:bold">|</span> cpio -o --format<span style="color:#ce5c00;font-weight:bold">=</span>newc &gt; ./rootfs.img
</span></span></code></pre></div><h2 id="启动qemu">启动qemu</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>qemu-system-arm -M vexpress-a9 -m 128M -kernel linux-5.15.53/arch/arm/boot/zImage -dtb linux-5.15.53/arch/arm/boot/dts/vexpress-v2p-ca9.dtb -append <span style="color:#4e9a06">&#34;root=/dev/ram rdinit=sbin/init console=ttyAMA0&#34;</span> -nographic -initrd rootfs/rootfs.img
</span></span></code></pre></div><p>启动成功
<img src="https://raw.githubusercontent.com/gitliulf/picture/main/image-20220718160906354.png" alt="image-20220718160906354"></p>

</div>





    
	
  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/TbusOS" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 The Docsy Authors </small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener"></a></small>
	
		<p class="mt-2"><a href="/about/">About Goldydocs</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>




  </body>
</html>
