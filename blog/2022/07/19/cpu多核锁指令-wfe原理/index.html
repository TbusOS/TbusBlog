<!doctype html>
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.101.0" />
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>cpu多核锁指令-WFE原理 | Tbus</title>
<meta name="description" content="今天我想分享一个跟多核锁原理相关的东西，由于我搞 arm 居多，所以目前只研究了 arm 架构下的 WFE 指令，分享出来，如果有表述不精准或者错误的地方还请大家指出，非常感谢。研究这个原因也是只是想搞清楚所以然和来龙去脉，以后写代码可以更游刃有余.">
<meta property="og:title" content="cpu多核锁指令-WFE原理" />
<meta property="og:description" content="今天我想分享一个跟多核锁原理相关的东西，由于我搞 arm 居多，所以目前只研究了 arm 架构下的 WFE 指令，分享出来，如果有表述不精准或者错误的地方还请大家指出，非常感谢。研究这个原因也是只是想搞清楚所以然和来龙去脉，以后写代码可以更游刃有余." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blog/2022/07/19/cpu%E5%A4%9A%E6%A0%B8%E9%94%81%E6%8C%87%E4%BB%A4-wfe%E5%8E%9F%E7%90%86/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2022-07-19T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-07-31T13:00:45+08:00" /><meta property="og:site_name" content="Tbus" />

<meta itemprop="name" content="cpu多核锁指令-WFE原理">
<meta itemprop="description" content="今天我想分享一个跟多核锁原理相关的东西，由于我搞 arm 居多，所以目前只研究了 arm 架构下的 WFE 指令，分享出来，如果有表述不精准或者错误的地方还请大家指出，非常感谢。研究这个原因也是只是想搞清楚所以然和来龙去脉，以后写代码可以更游刃有余."><meta itemprop="datePublished" content="2022-07-19T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-07-31T13:00:45+08:00" />
<meta itemprop="wordCount" content="1838">
<meta itemprop="keywords" content="arm,wfe,spin_lock," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="cpu多核锁指令-WFE原理"/>
<meta name="twitter:description" content="今天我想分享一个跟多核锁原理相关的东西，由于我搞 arm 居多，所以目前只研究了 arm 架构下的 WFE 指令，分享出来，如果有表述不精准或者错误的地方还请大家指出，非常感谢。研究这个原因也是只是想搞清楚所以然和来龙去脉，以后写代码可以更游刃有余."/>




<link rel="preload" href="/scss/main.min.cd6c2bbb05cdf98237b53882fed8c7a8b3fd7a7f7963d7cb305dd0d984782137.css" as="style">
<link href="/scss/main.min.cd6c2bbb05cdf98237b53882fed8c7a8b3fd7a7f7963d7cb305dd0d984782137.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK"
  crossorigin="anonymous"></script>
<script
  src="https://unpkg.com/lunr@2.3.9/lunr.min.js"
  integrity="sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli"
  crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-page td-blog">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="font-weight-bold">Tbus</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/about/" ><span>关于</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/docs/" ><span>文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/blog/" ><span class="active">博客</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/community/" ><span>团队</span></a>
			</li>
			
			
			<li class="nav-item dropdown mr-4 d-none d-lg-block">
				<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	版本
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/">Latest</a>
	
</div>

			</li>
			
			
			<li class="nav-item dropdown mr-4 d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	中文
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/en/">English</a>
	
</div>
			</li>
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; " aria-label="" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            
<div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    <input type="search" class="form-control td-search-input" placeholder="&#xf002; " aria-label="" autocomplete="off">

    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    <div class="nav-item dropdown d-block d-lg-none">
      

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	中文
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/en/">English</a>
	
</div>
    </div>
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-blog-li">
  <a href="/blog/" title="Docsy Blog" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-blog"><span class="">博客</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-blogbuild-environment-li">
  <a href="/blog/build-environment/" title="build-environment" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-blogbuild-environment"><span class="">环境搭建</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog20220720hugoe69e84e5bbba-li">
  <a href="/blog/2022/07/20/hugo%E6%9E%84%E5%BB%BA/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog20220720hugoe69e84e5bbba"><span class="">Hugo构建</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog20220720typora-picgo-li">
  <a href="/blog/2022/07/20/typora-picgo/" title="typora PicGo" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog20220720typora-picgo"><span class="">Typora 图床设置</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog20220720e585b3e4ba8etbus-li">
  <a href="/blog/2022/07/20/%E5%85%B3%E4%BA%8Etbus/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog20220720e585b3e4ba8etbus"><span class="">关于Tbus</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog20220718qemu-lunchlinux-li">
  <a href="/blog/2022/07/18/qemu-lunchlinux/" title="qemu-lunchlinux" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog20220718qemu-lunchlinux"><span class="">如何使用qemu启动linux</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-blogcpu-li">
  <a href="/blog/cpu/" title="CPU" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-blogcpu"><span class="">CPU Releases</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog20220719cpue5a49ae6a0b8e99481e68c87e4bba4-wfee58e9fe79086-li">
  <a href="/blog/2022/07/19/cpu%E5%A4%9A%E6%A0%B8%E9%94%81%E6%8C%87%E4%BB%A4-wfe%E5%8E%9F%E7%90%86/" title="cpu多核锁指令-WFE原理" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id="m-blog20220719cpue5a49ae6a0b8e99481e68c87e4bba4-wfee58e9fe79086"><span class="td-sidebar-nav-active-item">arm-wfe</span></a>
</li>
  </ul>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href="https://github.com/TbusOS/blog/tree/main/content/zh/blog/cpu/CPU-multi-core-lock-instruction-WFE-principle/index.md" class="td-page-meta--view" target="_blank" rel="noopener"><i class="fa fa-file-alt fa-fw"></i> </a>
  <a href="https://github.com/TbusOS/blog/edit/main/content/zh/blog/cpu/CPU-multi-core-lock-instruction-WFE-principle/index.md" class="td-page-meta--edit" target="_blank" rel="noopener"><i class="fa fa-edit fa-fw"></i> </a>
  <a href="https://github.com/TbusOS/blog/new/main/content/zh/blog/cpu/CPU-multi-core-lock-instruction-WFE-principle/index.md?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child" target="_blank" rel="noopener"><i class="fa fa-edit fa-fw"></i> </a>
  <a href="https://github.com/TbusOS/blog/issues/new?title=cpu%e5%a4%9a%e6%a0%b8%e9%94%81%e6%8c%87%e4%bb%a4-WFE%e5%8e%9f%e7%90%86" class="td-page-meta--issue" target="_blank" rel="noopener"><i class="fab fa-github fa-fw"></i> </a>
  <a href="https://github.com/TbusOS/issues/new" class="td-page-meta--project-issue" target="_blank" rel="noopener"><i class="fas fa-tasks fa-fw"></i> </a>
  <a id="print" href="/blog/cpu/_print/"><i class="fa fa-print fa-fw"></i> </a>

</div>

            


<div class="td-toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-背景简介">1 背景简介</a></li>
    <li><a href="#2-我与-wfe-的初次见面">2 我与 WFE 的初次见面</a></li>
    <li><a href="#3-spinlock-与-wfesevwfi">3 spinlock 与 WFE、SEV、WFI</a></li>
    <li><a href="#4-wfesev-与-wfi-的作用与工作原理">4 WFE、SEV 与 WFI 的作用与工作原理</a></li>
    <li><a href="#5-参考资料">5 参考资料</a></li>
  </ul>
</nav></div>



            

	
		
			
				
			
			



  
  
    <div class="taxonomy taxonomy-terms-cloud taxo-tags">
      
        <h5 class="taxonomy-title">Tag Cloud</h5>
      
      <ul class="taxonomy-terms">
        
          <li><a class="taxonomy-term" href="/tags/arm/" data-taxonomy-term="arm"><span class="taxonomy-label">arm</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/blog/" data-taxonomy-term="blog"><span class="taxonomy-label">blog</span><span class="taxonomy-count">3</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/docs/" data-taxonomy-term="docs"><span class="taxonomy-label">docs</span><span class="taxonomy-count">3</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/markdown/" data-taxonomy-term="markdown"><span class="taxonomy-label">markdown</span><span class="taxonomy-count">2</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/sample/" data-taxonomy-term="sample"><span class="taxonomy-label">sample</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/spin_lock/" data-taxonomy-term="spin_lock"><span class="taxonomy-label">spin_lock</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/tbus/" data-taxonomy-term="tbus"><span class="taxonomy-label">Tbus</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/test/" data-taxonomy-term="test"><span class="taxonomy-label">test</span><span class="taxonomy-count">2</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/typora/" data-taxonomy-term="typora"><span class="taxonomy-label">typora</span><span class="taxonomy-count">2</span></a></li>
        
          <li><a class="taxonomy-term" href="/tags/wfe/" data-taxonomy-term="wfe"><span class="taxonomy-label">wfe</span><span class="taxonomy-count">1</span></a></li>
        
      </ul>
    </div>
  

		
			
				
			
			



  
  
    <div class="taxonomy taxonomy-terms-cloud taxo-categories">
      
        <h5 class="taxonomy-title">Categories</h5>
      
      <ul class="taxonomy-terms">
        
          <li><a class="taxonomy-term" href="/categories/cpu/" data-taxonomy-term="cpu"><span class="taxonomy-label">cpu</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/categories/docs/" data-taxonomy-term="docs"><span class="taxonomy-label">docs</span><span class="taxonomy-count">3</span></a></li>
        
          <li><a class="taxonomy-term" href="/categories/examples/" data-taxonomy-term="examples"><span class="taxonomy-label">Examples</span><span class="taxonomy-count">2</span></a></li>
        
          <li><a class="taxonomy-term" href="/categories/linux/" data-taxonomy-term="linux"><span class="taxonomy-label">linux</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/categories/placeholders/" data-taxonomy-term="placeholders"><span class="taxonomy-label">Placeholders</span><span class="taxonomy-count">1</span></a></li>
        
          <li><a class="taxonomy-term" href="/categories/qemu/" data-taxonomy-term="qemu"><span class="taxonomy-label">qemu</span><span class="taxonomy-count">1</span></a></li>
        
      </ul>
    </div>
  

		
	

          </aside>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role="main">
            <a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href="/blog/cpu/index.xml" target="_blank">
              RSS <i class="fa fa-rss ml-2 "></i>
            </a>
            
<div class="td-content">
	<h1>cpu多核锁指令-WFE原理</h1>
	<div class="lead">今天我想分享一个跟多核锁原理相关的东西，由于我搞 arm 居多，所以目前只研究了 arm 架构下的 WFE 指令，分享出来，如果有表述不精准或者错误的地方还请大家指出，非常感谢。研究这个原因也是只是想搞清楚所以然和来龙去脉，以后写代码可以更游刃有余.</div>
	<div class="td-byline mb-4">
		 <b>sky (<a href="mailto:zhangbinghua2012@163.com">zhangbinghua2012@163.com</a>)</b> |
		<time datetime="2022-07-19" class="text-muted">2022.07.19</time>
	</div>
	<header class="article-meta">
		

  
    
      


<div class="taxonomy taxonomy-terms-article taxo-tags">
  <h5 class="taxonomy-title">Tags:</h5>
  <ul class="taxonomy-terms">
    
      <li><a class="taxonomy-term" href="/tags/arm/" data-taxonomy-term="arm"><span class="taxonomy-label">arm</span></a></li>
    
      <li><a class="taxonomy-term" href="/tags/wfe/" data-taxonomy-term="wfe"><span class="taxonomy-label">wfe</span></a></li>
    
      <li><a class="taxonomy-term" href="/tags/spin_lock/" data-taxonomy-term="spin_lock"><span class="taxonomy-label">spin_lock</span></a></li>
    
  </ul>
</div>

    
      


<div class="taxonomy taxonomy-terms-article taxo-categories">
  <h5 class="taxonomy-title">Categories:</h5>
  <ul class="taxonomy-terms">
    
      <li><a class="taxonomy-term" href="/categories/cpu/" data-taxonomy-term="cpu"><span class="taxonomy-label">cpu</span></a></li>
    
  </ul>
</div>

    
  

		
	</header>
	<p>本文最先发表于泰晓科技：</p>
<p>[https://tinylab.org/arm-wfe/]:</p>
<p><a href="https://tinylab.org/arm-wfe/#author-footer">Zhang Binghua</a> 创作于 2020/05/19</p>
<p>[TOC]</p>
<h2 id="1-背景简介">1 背景简介</h2>
<p>大家好，我叫张昺华，中间那个字和“饼”字一个读音，本人非常热衷技术，是个技术狂热者。</p>
<p>今天我想分享一个跟多核锁原理相关的东西，由于我搞 arm 居多，所以目前只研究了 arm 架构下的 WFE 指令，分享出来，如果有表述不精准或者错误的地方还请大家指出，非常感谢。研究这个原因也是只是想搞清楚所以然和来龙去脉，以后写代码可以更游刃有余。</p>
<h2 id="2-我与-wfe-的初次见面">2 我与 WFE 的初次见面</h2>
<p>偶然看 <code>spin_lock</code> 的 arm 架构下的 smp 源码的时候，发现了 <code>wfe()</code> 这个接口：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">arch_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">arch_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u32</span> <span style="color:#000">newval</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">arch_spinlock_t</span> <span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">prefetchw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">slock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__asm__</span> <span style="color:#000">__volatile__</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;1: ldrex %0, [%3]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; add %1, %0, %4</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; strex %2, %1, [%3]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; teq %2, #0</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; bne 1b&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">newval</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">slock</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;I&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">TICKET_SHIFT</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cc&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">next</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">owner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wfe</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">owner</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">READ_ONCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">owner</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">smp_mb</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>我印象之前的 kernel 是没有这个 wfe 这个函数的，当 cpu0 获取到锁后，如果 cpu1 再想获取锁，此时会被 lock 住，然后进入死等的状态，那么 wfe 这个指令的作用是会让 cpu 进入 low power standby，这样可以降低功耗，本来发生竞态时其他的 cpu 都要等待这个锁释放才能运行，有了这个指令，相当于是“因祸得福”了，还可以降低功耗，当然这是有条件的，后面追溯并研究了一下 wfe 这个指令的作用。</p>
<h2 id="3-spinlock-与-wfesevwfi">3 spinlock 与 WFE、SEV、WFI</h2>
<p>首先 <code>spin_lock</code> 函数，搞内核的大家都知道，那么我把 linux-stable 的代码黏贴出来如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">__always_inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">rlock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define raw_spin_lock(lock)	_raw_spin_lock(lock)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#ifndef CONFIG_INLINE_SPIN_LOCK
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">__lockfunc</span> <span style="color:#000">_raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">raw_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">EXPORT_SYMBOL</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_raw_spin_lock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">__raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">raw_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">preempt_disable</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">spin_acquire</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">dep_map</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_RET_IP_</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">LOCK_CONTENDED</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">do_raw_spin_trylock</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">do_raw_spin_lock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">* We are now relying on the NMI watchdog to detect lockup instead of doing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">* the detection here with an unfair lock which can cause problem of its own.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">do_raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">raw_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">debug_spin_lock_before</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">arch_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">raw_lock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mmiowb_spin_lock</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">debug_spin_lock_after</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">* ARMv6 ticket-based spin-locking.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">* A memory barrier is required after we get a lock, and before we
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">* release it, because V6 CPUs are assumed to have weakly ordered
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">* memory.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">arch_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">arch_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u32</span> <span style="color:#000">newval</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">arch_spinlock_t</span> <span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">prefetchw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">slock</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__asm__</span> <span style="color:#000">__volatile__</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;1: ldrex %0, [%3]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; add %1, %0, %4</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; strex %2, %1, [%3]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; teq %2, #0</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; bne 1b&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">newval</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">slock</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;I&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">TICKET_SHIFT</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cc&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">next</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">owner</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wfe</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">lockval</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">owner</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">READ_ONCE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">owner</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">smp_mb</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>对于 arm32：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#if __LINUX_ARM_ARCH__ &gt;= 7 || \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	(__LINUX_ARM_ARCH__ == 6 &amp;&amp; defined(CONFIG_CPU_32v6K))
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define sev()	__asm__ __volatile__ (&#34;sev&#34; : : : &#34;memory&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define wfe()	__asm__ __volatile__ (&#34;wfe&#34; : : : &#34;memory&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define wfi()	__asm__ __volatile__ (&#34;wfi&#34; : : : &#34;memory&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#else
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define wfe()	do { } while (0)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span></code></pre></div><p>对于 arm64：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define sev()		asm volatile(&#34;sev&#34; : : : &#34;memory&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define wfe()		asm volatile(&#34;wfe&#34; : : : &#34;memory&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define wfi()		asm volatile(&#34;wfi&#34; : : : &#34;memory&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">arch_spin_unlock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">arch_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">smp_mb</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">tickets</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">owner</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsb_sev</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define SEV		__ALT_SMP_ASM(WASM(sev), WASM(nop))
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">dsb_sev</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dsb</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ishst</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__asm__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">SEV</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#ifdef CONFIG_SMP
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __ALT_SMP_ASM(smp, up)						\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	&#34;9998: &#34; smp &#34;\n&#34;						\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	&#34; .pushsection \&#34;.alt.smp.init\&#34;, \&#34;a\&#34;\n&#34;		\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	&#34; .long 9998b\n&#34;					\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	&#34; &#34; up &#34;\n&#34;						\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">	&#34; .popsection\n&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#else
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#define __ALT_SMP_ASM(smp, up)	up
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span></code></pre></div><p>以上我们可以看出，在 lock 的时候使用 WFE，在 unlock 的时候使用 SEV，这个必须要成对使用，原因我下面会说。</p>
<p>对于内核版本 Linux 3.0.56：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">arch_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">arch_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">__asm__</span> <span style="color:#000">__volatile__</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;1: ldrex %0, [%1]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; teq %0, #0</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">WFE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ne&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; strexeq %0, %2, [%1]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; teqeq %0, #0</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; bne 1b&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cc&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">smp_mb</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>对于 Linux 2.6.18：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">define</span> <span style="color:#000">_raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>     <span style="color:#000">__raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">raw_lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">inline</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">__raw_spin_lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">raw_spinlock_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__asm__</span> <span style="color:#000">__volatile__</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34;1: ldrex %0, [%1]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; teq %0, #0</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; strexeq %0, %2, [%1]</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; teqeq %0, #0</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">&#34; bne 1b&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;=&amp;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;cc&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">smp_mb</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>以上大家可以看出，最早期的 kernel 版本是没有 wfe 这条指令的，后面的版本才有。</p>
<h2 id="4-wfesev-与-wfi-的作用与工作原理">4 WFE、SEV 与 WFI 的作用与工作原理</h2>
<p>那这条指令的作用是什么呢？我们可以上 arm 官网去查看这条指令的描述：<a href="http://infocenter.arm.com/help/index.jsp?lang=en">ARM Software development tools</a></p>
<ul>
<li>
<p>SEV</p>
<blockquote>
<p>SEV causes an event to be signaled to all cores within a multiprocessor system. If SEV is implemented, WFE must also be implemented.</p>
</blockquote>
</li>
</ul>
<p>SEV 指令可以产生事件信号，发送给全部的 cpu，让他们唤醒。如果 SEV 实现了，那么 WFE 也必须被实现。这里的事件信号其实会表现为 Event register，这是个一 bit 的 register，如果有事件，那么此 bit 为真。</p>
<ul>
<li>WFE</li>
</ul>
<blockquote>
<p>If the Event Register is not set, WFE suspends execution until one of the following events occurs:</p>
<p>• an IRQ interrupt, unless masked by the CPSR I-bit • an FIQ interrupt, unless masked by the CPSR F-bit • an Imprecise Data abort, unless masked by the CPSR A-bit • a Debug Entry request, if Debug is enabled • an Event signaled by another processor using the SEV instruction.</p>
<p>If the Event Register is set, WFE clears it and returns immediately. If WFE is implemented, SEV must also be implemented.</p>
</blockquote>
<p>对于 WFE，如果 Event Register 没有设置，WFE 会让 cpu 进入 low-power state，直到下面列举的五个 events 产生，比如说中断等等都会唤醒当前因为 WFE 而 suspend 的cpu。</p>
<p>如果 Event Register 被设置了，那么 WFE 会直接返回，不让 cpu 进入low-power state，目的是因为既然有事件产生了，说明当前 cpu 需要干活，不能 suspend，所以才这样设计。</p>
<p>这里我很好奇 Event Register 到底是怎么理解的。因此需要阅读手册《ARM Architecture Reference Manual.pdf》，下面我会做说明。</p>
<ul>
<li>WFI</li>
</ul>
<blockquote>
<p>WFI suspends execution until one of the following events occurs:</p>
<p>• an IRQ interrupt, regardless of the CPSR I-bit • an FIQ interrupt, regardless of the CPSR F-bit • an Imprecise Data abort, unless masked by the CPSR A-bit • a Debug Entry request, regardless of whether Debug is enabled.</p>
</blockquote>
<p>而对于 WFI 这种，不会判断 Event register，暴力的直接让 cpu 进入 low-power state，直到有上述四个 events 产生才会唤醒 cpu。</p>
<p>注意，这里 WFE 比 WFI 多了一个唤醒特性：</p>
<blockquote>
<p>an Event signaled by another processor using the SEV instruction.</p>
</blockquote>
<p>也就是说 SEV 是不会唤醒 WFI 指令休眠的 cpu 的。这点需要特别注意。</p>
<p>接下来我谈下这个 Event Register 是怎么回事了。看这个文档《ARM Architecture Reference Manual.pdf》</p>
<ul>
<li>The Event Register</li>
</ul>
<blockquote>
<p>The Event Register is a single bit register for each processor. When set, an event register indicates that an event has occurred, since the register was last cleared, that might require some action by the processor. Therefore, the processor must not suspend operation on issuing a WFE instruction.</p>
<p>The reset value of the Event Register is UNKNOWN.</p>
<p>The Event Register is set by:</p>
<p>• an SEV instruction • an event sent by some IMPLEMENTATION DEFINED mechanism • a debug event that causes entry into Debug state • an exception return.</p>
<p>As shown in this list, the Event Register might be set by IMPLEMENTATION DEFINED mechanisms. The Event Register is cleared only by a Wait For Event instruction. Software cannot read or write the value of the Event Register directly.</p>
</blockquote>
<p>以上就是 Event Register 的表述，上述已经说的很明白了，Event Register 只有一个 bit，可以被 set 的情况总有四种大类型。当任意一个条件满足的时候，Event Register 都可以被 set，那么当 WFE 进入的时候会进行 Event Register 的判断，如果为真，就直接返回。</p>
<p>再来看看 WFE 的介绍：</p>
<blockquote>
<p>Wait For Event is a hint instruction that permits the processor to enter a low-power state until one of a number of events occurs, including events signaled by executing the SEV instruction on any processor in the multiprocessor system. For more information, see Wait For Event and Send Event on page B1-1197.</p>
<p>In an implementation that includes the Virtualization Extensions, if HCR.TWE is set to 1, execution of a WFE instruction in a Non-secure mode other than Hyp mode generates a Hyp Trap exception if, ignoring the value of the HCR.TWE bit, conditions permit the processor to suspend execution. For more information see Trapping use of the WFI and WFE instructions on page B1-1249.</p>
</blockquote>
<p>接下来上 WFE 这条指令的伪代码流程：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">Assembler</span> <span style="color:#000">syntax</span>
</span></span><span style="display:flex;"><span><span style="color:#000">WFE</span><span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">c</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">}{</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">q</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">where</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">c</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">q</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">See</span> <span style="color:#000">Standard</span> <span style="color:#000">assembler</span> <span style="color:#000">syntax</span> <span style="color:#000">fields</span> <span style="color:#000">on</span> <span style="color:#000">page</span> <span style="color:#000">A8</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">285.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Operation</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ConditionPassed</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">EncodingSpecificOperations</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">EventRegistered</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ClearEventRegister</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">HaveVirtExt</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">IsSecure</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">CurrentModeIsHyp</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">HCR</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TWE</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;1&#39;</span> <span style="color:#000">then</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">HSRString</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Zeros</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">HSRString</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;1&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">WriteHSR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">&#39;</span><span style="color:#0000cf;font-weight:bold">000001</span><span style="color:#a40000">&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HSRString</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">TakeHypTrapException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">WaitForEvent</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Exceptions</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Hyp</span> <span style="color:#000">Trap</span><span style="color:#000;font-weight:bold">.</span>
</span></span></code></pre></div><p>看了上面这段 WFE 的伪代码，一目了然，首先判断 <code>ConditionPassed()</code>，这些函数大家可以在 arm 手册中查看其详细含义，如果 <code>EventResigerted()</code> 函数为真，也就是这个 1 bit 的寄存器为真，那么就清除此 bit，然后退出返回，不会让 cpu 进入 low power state；</p>
<p>如果不是异常处理，<code>TakeHypTrapException()</code>，那么就 <code>WaitForEvent()</code>，等待唤醒事件到来，到来了，就唤醒当前 cpu。</p>
<p>为什么有事件来了就直接返回呢，因为 WFE 的设计认为，如果此时有 event 事件，那么说明当前 cpu 要干活，那就没必要进入 low power state 模式。</p>
<p>如果没有事件产生，那么就可以进入 low power state 模式，因为 cpu 反正也是在等待锁，此时也干不了别的事情，还不如休眠还可以降低功耗。</p>
<p>当然，irq，fiq 等很多中断都可以让 WFE 休眠的 cpu 唤醒，那么这样做还有什么意义呢？比如说时钟中断是一直产生的，那么 cpu 很快就醒了啊，都不用等到发 SEV，那么既然是用 <code>spin_lock</code>，也可以在中断上半部使用，也可以在进程上下文，既然是自旋锁，就意味着保护的这段代码是要足够精简，不希望被其他东西打断，那么如果你保护的这部分代码非常长，这时候整个系统响应很可能会变慢，因为如果这时候有人也要使用这个锁的话，那么是否保护的这段代码设计上是有问题的。因此用 <code>spin_lock</code> 保护的函数尽可能要短，如果长的话可能需要换其他锁，或者考虑下是否真的要这么长的保护措施。</p>
<p><strong><code>TakeHypTrapException()</code>，是进入异常处理</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">Pseudocode</span> <span style="color:#000">description</span> <span style="color:#000">of</span> <span style="color:#000">taking</span> <span style="color:#000">the</span> <span style="color:#000">Hyp</span> <span style="color:#000">Trap</span> <span style="color:#000">exception</span>
</span></span><span style="display:flex;"><span><span style="color:#000">The</span> <span style="color:#000">TakeHypTrapException</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">pseudocode</span> <span style="color:#000">procedure</span> <span style="color:#000">describes</span> <span style="color:#000">how</span> <span style="color:#000">the</span> <span style="color:#000">processor</span> <span style="color:#000">takes</span> <span style="color:#000">the</span> <span style="color:#f57900">exception</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TakeHypTrapException()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ======================
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">TakeHypTrapException</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// HypTrapException is caused by executing an instruction that is trapped to Hyp mode as a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// result of a trap set by a bit in the HCR, HCPTR, HSTR or HDCR. By definition, it can only
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// be generated in a Non-secure mode other than Hyp mode.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Note that, when a Supervisor Call exception is taken to Hyp mode because HCR.TGE==1, this
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// is not a trap of the SVC instruction. See the TakeSVCException() pseudocode for this case.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">preferred_exceptn_return</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">CPSR</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;1&#39;</span> <span style="color:#000">then</span> <span style="color:#000">PC</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000">PC</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">new_spsr_value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">CPSR</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">EnterHypMode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">new_spsr_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">preferred_exceptn_return</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Additional</span> <span style="color:#000">pseudocode</span> <span style="color:#000">functions</span> <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">exception</span> <span style="color:#000">handling</span> <span style="color:#000">on</span> <span style="color:#000">page</span> <span style="color:#000">B1</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1221</span> <span style="color:#000">defines</span> <span style="color:#000">the</span> <span style="color:#000">EnterHypMode</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">pseudocode</span>
</span></span><span style="display:flex;"><span><span style="color:#000">procedure</span><span style="color:#000;font-weight:bold">.</span>
</span></span></code></pre></div>






<div class="card rounded p-2 td-post-card mb-4 mt-4" style="max-width: 610px">
	<img class="card-img-top" src="/blog/2022/07/19/cpu%E5%A4%9A%E6%A0%B8%E9%94%81%E6%8C%87%E4%BB%A4-wfe%E5%8E%9F%E7%90%86/image-20220719201300279_hu16ba9ede6f8109a7933eccf29aa0d9ee_82343_600x300_fill_catmullrom_smart1_3.png" width="600" height="300">
	
	<div class="card-body px-0 pt-2 pb-0">
		<p class="card-text">
Fetch and scale an image in the upcoming Hugo 0.43.
<small class="text-muted"><br/>Photo: CC-BY-CA</small></p>
	</div>
	
</div>
<p><strong>ClearEventRegister()</strong></p>
<p>Clear the Event Register of the current processor 清除Event Register的bit</p>
<p><strong>EventRegistered()</strong></p>
<p>Determine whether the Event Register of the current processor is set Event Register bit为真，即被设置过</p>
<p><strong>WaitForEvent()</strong></p>
<p>Wait until WFE instruction completes</p>
<p>等待 Events 事件，有任何一个 Event 事件来临，都会唤醒当前被 WFE suspend 下去的 cpu， 如果是 SEV，会唤醒全部被 WFE suspend 下去的cpu。</p>
<p>如下是关于 WFE 的 wake up events 事件描述和列举：</p>
<blockquote>
<p>WFE wake-up events</p>
<p>The following events are WFE wake-up events:</p>
<p>• the execution of an SEV instruction on any processor in the multiprocessor system • a physical IRQ interrupt, unless masked by the CPSR.I bit • a physical FIQ interrupt, unless masked by the CPSR.F bit • a physical asynchronous abort, unless masked by the CPSR.A bit • in Non-secure state in any mode other than Hyp mode: — when HCR.IMO is set to 1, a virtual IRQ interrupt, unless masked by the CPSR.I bit — when HCR.FMO is set to 1, a virtual FIQ interrupt, unless masked by the CPSR.F bit — when HCR.AMO is set to 1, a virtual asynchronous abort, unless masked by the CPSR.A bit • an asynchronous debug event, if invasive debug is enabled and the debug event is permitted • an event sent by the timer event stream, see Event streams on page B8-1934 • an event sent by some IMPLEMENTATION DEFINED mechanism.</p>
<p>In addition to the possible masking of WFE wake-up events shown in this list, when invasive debug is enabled and DBGDSCR[15:14] is not set to 0b00, DBGDSCR.INTdis can mask interrupts, including masking them acting as WFE wake-up events. For more information, see DBGDSCR, Debug Status and Control Register on page C11-2206. As shown in the list of wake-up events, an implementation can include IMPLEMENTATION DEFINED hardware mechanisms to generate wake-up events. NoteFor more information about CPSR masking see Asynchronous exception masking on page B1-1181. If the configuration of the masking controls provided by the Security Extensions, or Virtualization Extensions, mean that a CPSR mask bit cannot mask the corresponding exception, then the physical exception is a WFE wake-up event, regardless of the value of the CPSR mask bit.</p>
</blockquote>
<p>接下来我们看下 WFI 的伪代码：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">Assembler</span> <span style="color:#000">syntax</span>
</span></span><span style="display:flex;"><span><span style="color:#000">WFI</span><span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">c</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">}{</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">q</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">where</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">c</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">q</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">See</span> <span style="color:#000">Standard</span> <span style="color:#000">assembler</span> <span style="color:#000">syntax</span> <span style="color:#000">fields</span> <span style="color:#000">on</span> <span style="color:#000">page</span> <span style="color:#000">A8</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">285.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Operation</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ConditionPassed</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">EncodingSpecificOperations</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">HaveVirtExt</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">IsSecure</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">CurrentModeIsHyp</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">HCR</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TWI</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;1&#39;</span> <span style="color:#000">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">HSRString</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Zeros</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">HSRString</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;1&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">WriteHSR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">&#39;</span><span style="color:#0000cf;font-weight:bold">000001</span><span style="color:#a40000">&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HSRString</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">TakeHypTrapException</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">WaitForInterrupt</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Exceptions</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Hyp</span> <span style="color:#000">Trap</span><span style="color:#000;font-weight:bold">.</span>
</span></span></code></pre></div><p>相关解释：</p>
<blockquote>
<p>WFI</p>
<p>Wait For Interrupt is a hint instruction that permits the processor to enter a low-power state until one of a number of asynchronous events occurs. For more information, see Wait For Interrupt on page B1-1200. In an implementation that includes the Virtualization Extensions, if HCR.TWI is set to 1, execution of a WFE instruction in a Non-secure mode other than Hyp mode generates a Hyp Trap exception if, ignoring the value of the HCR.TWI bit, conditions permit the processor to suspend execution. For more information see Trapping use of the WFI and WFE instructions on page B1-1249.</p>
</blockquote>
<p>以上我们可以看出，WFI 并没有去判断 event register，因此看伪代码可以很直观的看出 WFI 与 WFE 的区别。</p>
<p>以上是我个人的理解，如果有表述不精准或者不准确的地方还请大家指出，欢迎交流。</p>
<h2 id="5-参考资料">5 参考资料</h2>
<ul>
<li><a href="https://blog.csdn.net/adaptiver/article/details/72389453">ARM 架构下 spinlock 原理 (代码解读)</a></li>
<li><a href="http://www.wowotech.net/armv8a_arch/wfe_wfi.html">ARM WFI 和 WFE 指令</a></li>
<li><a href="http://infocenter.arm.com/help/index.jsp?lang=en">ARM Software development tools</a></li>
<li><a href="https://www.jianshu.com/p/f0d6e7103d9b">Linux 内核自旋锁 <code>spinlock_t</code> 机制</a></li>
</ul>

	

	<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
  <li>
    <a class="btn btn-primary disabled"><span class="mr-1">←</span></a>
  </li>
    <a class="btn btn-primary disabled"><span class="ml-1">→</span></a>
  </li>
</ul>

</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/TbusOS" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 The Docsy Authors </small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener"></a></small>
	
		<p class="mt-2"><a href="/about/">About Goldydocs</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>




















<script src="/js/main.min.91798a335c881f1b6b805085ba4aa22d1dbd2b0b18d105d05189fa104ddae350.js" integrity="sha256-kXmKM1yIHxtrgFCFukqiLR29KwsY0QXQUYn6EE3a41A=" crossorigin="anonymous"></script>




  </body>
</html>